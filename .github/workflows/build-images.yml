
name: keg-build
on:
  push:
    branches:
      - ZEN-543-rebuild-workflow
      - develop

jobs:
  build-images:
    name: 'Build Images'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      CLI_BRANCH: ZEN-543-rebuild-workflow
      CLI_PATH: $GITHUB_WORKSPACE/keg-cli
      CLI_USER: keg-admin
      GIT_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
    - name: "Clone Keg-CLI"
      id: clone-cli
      run: git -C $GITHUB_WORKSPACE clone --single-branch --branch ${{env.CLI_BRANCH}} https://github.com/simpleviewinc/keg-cli.git
    - name: "Install Keg-CLI"
      id: install-cli
      run: yarn --cwd $GITHUB_WORKSPACE/keg-cli install
    - name: "Setup Keg-CLI"
      id: setup-cli
      run: cd $GITHUB_WORKSPACE/keg-cli; KEG_HUB_BRANCH=${GITHUB_REF##*/} KEG_ROOT_DIR=$GITHUB_WORKSPACE/keg-hub bash scripts/ci/setupCLIConfig.sh
    - name: "Set Docker User"
      id: set-docker-user
      run: source $GITHUB_WORKSPACE/keg-cli/keg && keg config set key=docker.user value=${{env.CLI_USER}} --confirm false
    - name: "Set Docker Token"
      id: set-token
      run: source $GITHUB_WORKSPACE/keg-cli/keg && keg config set key=cli.git.key value=${{ env.GIT_TOKEN }} --confirm false
    - name: "Set Git Username"
      id: set-git-user
      run: git config --global user.name ${{env.CLI_USER}}
    - name: "Docker Login"
      id: docker-login
      run: source $GITHUB_WORKSPACE/keg-cli/keg && GIT_KEY=${{ env.GIT_TOKEN }} keg dp login
    - name: "Link Taps"
      id: link-taps
      run: cd $GITHUB_WORKSPACE/keg-hub && node scripts/ci/linkTaps.js
    - name: "Build and Push"
      id: build-push-images
      run: source $GITHUB_WORKSPACE/keg-cli/keg && keg src && keg cli && GIT_KEY=${{env.GIT_TOKEN}} KEG_REPO=retheme KEG_CLI_PATH=${{env.CLI_PATH}} bash scripts/ci/buildPushDockerImages.sh
