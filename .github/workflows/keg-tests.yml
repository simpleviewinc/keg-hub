name: keg-tests
on: push

jobs:
  tests:
    name: 'Run Tests'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: "Run Tests"
        shell: bash
        run: |
          echo "::debug::{Running keg-tests check...}"
          git fetch origin --force --depth=1
          KEG_DIR="${PWD##*/}"
          REPOS=($(ls repos))
          CHANGE_FILES=($(git diff --name-only origin/develop))
          
          echo "::debug::{Found changed files...}"

          for REPO in "${REPOS[@]}"; do

            REPO_PATH="repos/${REPO##*/}"
            RUN_TESTS="false"

            for FILE in "${CHANGE_FILES[@]}"; do
              if [[ "$FILE" =~ "$REPO_PATH" ]]; then
                RUN_TESTS="true"
              fi
            done

            if [[ "$RUN_TESTS" == "true" ]]; then
              echo "::debug::{Found changed file for repo $REPO_PATH}"
              cd $REPO_PATH
              yarn install
              yarn test
              echo "::debug::{Finished running tests for repo $REPO_PATH}"
            fi

          done
          echo "::debug::{Finished running tests for keg-hub}"





