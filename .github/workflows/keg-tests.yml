name: keg-tests
on: push

jobs:
  tests:
    name: 'Run Tests'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: "Get Changed Files"
        id: get-changed-files
        shell: bash
        run: |
          # Pull down origin, so we have access to all branches
          git fetch origin --force --depth=1

          # Write the changed files to a local file
          git diff --name-only origin/develop >> ../keg-changed-files.txt
      - name: "Get Changed Repos"
        id: get-changed-repos
        shell: bash
        run: |
          # Get all keg-hub repos
          REPOS=($(ls repos))

          # Get the changed files, and create the change-repos file
          CHANGED_FILES=($(cat ../keg-changed-files.txt))
          touch ../keg-changed-repos.txt

          # Loop over the repos and run the tests on them
          for REPO in "${REPOS[@]}"; do

            # Don't run tests for keg-cli ( currently requires a docker setup )
            if [[ "$REPO" == "keg-cli" ]]; then
              continue
            fi

            # Get the full repos path
            REPO_PATH="repos/${REPO##*/}"

            # Loop over the files and look for any that match the current repo
            for FILE in "${CHANGED_FILES[@]}"; do
              if [[ "$FILE" =~ "$REPO_PATH" ]]; then
                # If there a matching path, write the repo path to the local change-repos.txt
                echo "$REPO_PATH" >> ../keg-changed-repos.txt
                break
              fi
            done

          done
      - name: "Run Repo Tests"
        id: run-repo-tests
        shell: bash
        run: |
          # Load the changed repos from the last step
          REPOS=($(cat ../keg-changed-repos.txt))

          # Loop over the repos and run the tests on them
          for REPO_PATH in "${REPOS[@]}"; do
            cd $REPO_PATH
            yarn install
            yarn test
          done
