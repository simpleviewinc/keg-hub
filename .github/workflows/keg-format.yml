
name: keg-format
on: push

jobs:
  tests:
    name: 'Format Repo Code'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: "Get Changed Files"
        id: get-changed-files
        shell: bash
        run: bash scripts/ci/getChangedFiles.sh
      - name: "Get Changed Repos"
        id: get-changed-repos
        shell: bash
        run: bash scripts/ci/getChangedRepos.sh
      - name: Get Yarn Cache Directory
        id: get-yarn-cache-dir
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2
        id: yarn-cache
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            repos/**/node_modules
          key: ${{ runner.os }}-modules-${{ hashFiles('repos/**/yarn.lock') }}
      - name: Install Yarn Dependencies
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: bash scripts/ci/runYarnCmd.sh "install"
      - name: "Run Repo Format"
        id: run-repo-format
        shell: bash
        run: bash scripts/ci/runYarnCmd.sh "format"
      - name: "Commit Repo Changes"
        id: commit-changes
        shell: bash
        run: bash scripts/ci/commitChanges.sh